#!/bin/bash

#################################################################
#### author: @slickstack
#### link: https://github.com/littlebizzy/slickstack
#### mirror: http://mirrors.littlebizzy.com/bash/bash-worker
#### type: bash script
#### purpose: updates all server config files
#### location: /var/www/bash-worker
#### slug: bash-worker
#### version: master
#### executable: yes
#################################################################

## include server config variables ##
source /var/www/config

## delete previous tmp files ##
rm -R -f /tmp/1-cron-often.txt* /tmp/1-cron-often*
rm -R -f /tmp/bash-check.txt* /tmp/bash-check*
rm -R -f /tmp/gai-conf.txt* /tmp/gai.conf*
rm -R -f /tmp/monitrc.txt* /tmp/monitrc*
rm -R -f /tmp/nginx-conf.txt* /tmp/nginx.conf*
rm -R -f /tmp/nginx.crt* /tmp/nginx.key* /tmp/nginx.pem*
rm -R -f /tmp/php-ini.txt* /tmp/php.ini*
rm -R -f /tmp/php-fpm-conf.txt* /tmp/php-fpm.conf*
rm -R -f /tmp/redis-conf.txt* /tmp/redis.conf*
rm -R -f /tmp/ufw-conf.txt* /tmp/ufw.conf*
rm -R -f /tmp/user-rules.txt* /tmp/user.rules*
rm -R -f /tmp/www-conf.txt* /tmp/www.conf*

# download latest scripts and configs ##
cd /tmp/
wget --no-cache http://mirrors.littlebizzy.com/crons/1-cron-often.txt
wget --no-cache http://mirrors.littlebizzy.com/bash/bash-check.txt
wget --no-cache http://mirrors.littlebizzy.com/ubuntu/gai-conf.txt
wget --no-cache http://mirrors.littlebizzy.com/monit/monitrc.txt
wget --no-cache http://mirrors.littlebizzy.com/nginx/nginx-conf.txt
wget --no-cache http://mirrors.littlebizzy.com/php/php-ini.txt
wget --no-cache http://mirrors.littlebizzy.com/php/php-fpm-conf.txt
wget --no-cache http://mirrors.littlebizzy.com/redis/redis-conf.txt
wget --no-cache http://mirrors.littlebizzy.com/ubuntu/ufw-conf.txt
wget --no-cache http://mirrors.littlebizzy.com/ubuntu/user-rules.txt
wget --no-cache http://mirrors.littlebizzy.com/php/www-conf.txt

## rename scripts and configs ##
cd /tmp/
mv 1-cron-often.txt 1-cron-often
mv bash-check.txt bash-check
mv gai-conf.txt gai.conf
mv monitrc.txt monitrc
mv nginx-conf.txt nginx.conf
mv php-ini.txt php.ini
mv php-fpm-conf.txt php-fpm.conf
mv redis-conf.txt redis.conf
mv ufw-conf.txt ufw.conf
mv user-rules.txt user.rules
mv www-conf.txt www.conf

## copy scripts and configs to their destinations ##
cp -R -f -d --no-preserve=mode,ownership /tmp/1-cron-often /var/www/1-cron-often
cp -R -f -d --no-preserve=mode,ownership /tmp/bash-check /var/www/bash-check
cp -R -f -d --no-preserve=mode,ownership /tmp/gai.conf /etc/gai.conf
cp -R -f -d --no-preserve=mode,ownership /tmp/monitrc /etc/monit/monitrc
cp -R -f -d --no-preserve=mode,ownership /tmp/nginx.conf /etc/nginx/nginx.conf
cp -R -f -d --no-preserve=mode,ownership /tmp/php.ini /etc/php/7.0/cli/php.ini
cp -R -f -d --no-preserve=mode,ownership /tmp/php.ini /etc/php/7.0/fpm/php.ini
cp -R -f -d --no-preserve=mode,ownership /tmp/php-fpm.conf /etc/php/7.0/fpm/php-fpm.conf
cp -R -f -d --no-preserve=mode,ownership /tmp/redis.conf /etc/redis/redis.conf
cp -R -f -d --no-preserve=mode,ownership /tmp/ufw.conf /etc/ufw/ufw.conf
cp -R -f -d --no-preserve=mode,ownership /tmp/user.rules /etc/ufw/user.rules
cp -R -f -d --no-preserve=mode,ownership /tmp/www.conf /etc/php/7.0/fpm/pool.d/www.conf

## generate pem file from openssl key and crt files ##
cp -R -f -d --no-preserve=mode,ownership /etc/ssl/nginx.crt /tmp/nginx.crt
cp -R -f -d --no-preserve=mode,ownership /etc/ssl/nginx.key /tmp/nginx.key
cat /tmp/nginx.crt /tmp/nginx.key > /tmp/nginx.pem
cp -R -f -d --no-preserve=mode,ownership /tmp/nginx.pem /etc/ssl/nginx.pem

## delete remaining tmp files ##
rm -R -f /tmp/1-cron-often.txt* /tmp/1-cron-often*
rm -R -f /tmp/bash-check.txt* /tmp/bash-check*
rm -R -f /tmp/gai-conf.txt* /tmp/gai.conf*
rm -R -f /tmp/monitrc.txt* /tmp/monitrc*
rm -R -f /tmp/nginx-conf.txt* /tmp/nginx.conf*
rm -R -f /tmp/nginx.crt* /tmp/nginx.key* /tmp/nginx.pem*
rm -R -f /tmp/php-ini.txt* /tmp/php.ini*
rm -R -f /tmp/php-fpm-conf.txt* /tmp/php-fpm.conf*
rm -R -f /tmp/redis-conf.txt* /tmp/redis.conf*
rm -R -f /tmp/ufw-conf.txt* /tmp/ufw.conf*
rm -R -f /tmp/user-rules.txt* /tmp/user.rules*
rm -R -f /tmp/www-conf.txt* /tmp/www.conf*

## reset file permissions ##
chown root:root /var/www/1-cron-often
chmod -R 700 /var/www/1-cron-often
chown root:root /var/www/bash-check
chmod -R 700 /var/www/bash-check
chown root:root /etc/gai.conf
chown root:root /etc/monit/monitrc
chmod -R 700 /etc/monit/monitrc
chown root:root /etc/nginx/nginx.conf
chown root:root /etc/ssl/nginx.crt /etc/ssl/nginx.key /etc/ssl/nginx.pem
chmod -R 700 /etc/ssl/nginx.crt /etc/ssl/nginx.key /etc/ssl/nginx.pem
chown root:root /etc/php/7.0/cli/php.ini
chown root:root /etc/php/7.0/fpm/php.ini
chown root:root /etc/php/7.0/fpm/php-fpm.conf
chown root:root /etc/redis/redis.conf
chown root:root /etc/ufw/ufw.conf
chown root:root /etc/ufw/user.rules
chown root:root /etc/php/7.0/fpm/pool.d/www.conf

## restart services ##
/etc/init.d/nginx restart
/etc/init.d/php7.0-fpm restart
/etc/init.d/redis restart
/etc/init.d/monit restart
/etc/init.d/ufw restart

#####################################################
#### littlebizzy perform various temporary tasks ####
#####################################################

## TEMP change crontab ##
# sed -i "s/ups-cron/lemp-updates/g" /var/spool/cron/crontabs/root
# sed -i "s/perms-cron/perms-reset/g" /var/spool/cron/crontabs/root
# sed -i "s/permissions-reset/perms-reset/g" /var/spool/cron/crontabs/root
# sed -i "s/worker-cron/bash-worker/g" /var/spool/cron/crontabs/root
# sed -i "s/check-cron/bash-check/g" /var/spool/cron/crontabs/root
# sed -i "s/muplugs-cron/muplugs-install/g" /var/spool/cron/crontabs/root
# sed -i "s/wordpress-muplugins-install/muplugs-install/g" /var/spool/cron/crontabs/root

## TEMP change error log path ##
# sed -i "s#/var/log/nginx/error.log#/var/log/php-fpm/error.log#g" /var/www/html/wp-config.php


