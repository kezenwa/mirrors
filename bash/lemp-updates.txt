#!/bin/bash

###############################################
#### littlebizzy lemp updates and upgrades ####
###############################################

#########################################
#### DO NOT CALL DIRECTLY IN CRONTAB ####
#########################################

## fix dpkg ##
DEBIAN_FRONTEND=noninteractive dpkg --configure -a --force-confold

## update repos ##
source /var/www/apt-update

## install linux utilities ##
source /var/www/linux-utils-install

## install or upgrade php and extensions ##
source /var/www/php-install

## install or upgrade git ##
DEBIAN_FRONTEND=noninteractive DEBIAN_PRIORITY=critical PATH='/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin' /usr/bin/apt-get -q --yes -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" install git

## install monit ##
source /var/www/monit-install

## install wp-cli ##
source /var/www/wpcli-install

## install or upgrade redis server and php redis ##
DEBIAN_FRONTEND=noninteractive DEBIAN_PRIORITY=critical PATH='/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin' /usr/bin/apt-get -q --yes -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" install redis-server
DEBIAN_FRONTEND=noninteractive DEBIAN_PRIORITY=critical PATH='/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin' /usr/bin/apt-get -q --yes -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" install php-redis

## install ufw ##
source /var/www/ufw-install

## dpkg default to confold ##
DEBIAN_FRONTEND=noninteractive dpkg --configure -a --force-confold

## upgrade lemp ##
source /var/www/apt-update
source /var/www/apt-upgrade

## cleanup packages and dependencies ##
DEBIAN_FRONTEND=noninteractive DEBIAN_PRIORITY=critical PATH='/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin' /usr/bin/apt-get -q --yes -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" autoremove
DEBIAN_FRONTEND=noninteractive DEBIAN_PRIORITY=critical PATH='/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin' /usr/bin/apt-get -q --yes -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" autoclean

## restart services ##
/etc/init.d/php7.0-fpm restart
/etc/init.d/nginx restart
/etc/init.d/monit restart
